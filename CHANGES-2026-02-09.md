# Code Changes - February 9, 2026

## Summary

Updated `integrated_task_worker.py` with security fixes, version management, and Git integration.

---

## Changes Made

### 1. Security Fix: Dataverse Authentication

**Problem**: Command injection vulnerability (shell=True with subprocess)

**Solution**: Replaced with Azure DefaultAzureCredential

**Before (lines 63-79)**:
```python
def get_token(self):
    """Get OAuth token from Azure CLI"""
    az_command = r"C:\Program Files (x86)\Microsoft SDKs\Azure\CLI2\wbin\az.cmd"
    result = subprocess.run(
        [az_command, "account", "get-access-token", ...],
        shell=True  # SECURITY RISK!
    )
    return result.stdout.strip()
```

**After**:
```python
def get_token(self):
    """Get OAuth token using DefaultAzureCredential (secure, cached)"""
    # Return cached token if still valid
    if self._token_cache and self._token_expires:
        if datetime.now() < self._token_expires:
            return self._token_cache

    # Get new token
    token = self.credential.get_token(f"{DATAVERSE_URL}/.default")
    self._token_cache = token.token
    self._token_expires = datetime.fromtimestamp(token.expires_on) - timedelta(minutes=5)
    return self._token_cache
```

**Benefits**:
- ‚úÖ No command injection vulnerability
- ‚úÖ Token caching (reduces API calls from 4x to 1x per hour)
- ‚úÖ Automatic token refresh
- ‚úÖ No hardcoded paths

---

### 2. Version Management

**Added**:
- `load_version()` - Read local VERSION file
- `check_for_updates()` - Check remote VERSION every 10 min (when idle)
- `apply_update()` - Git pull and restart

**Flow**:
1. Worker checks VERSION every 10 minutes (only when idle, not during task execution)
2. If new version available: Pull and restart
3. Task Scheduler automatically restarts worker

**Code added**:
```python
def check_for_updates(self):
    """Check if new version available (when idle)"""
    # Fetch latest
    subprocess.run(["git", "fetch"], cwd=self.repo_path)

    # Read remote VERSION
    result = subprocess.run(
        ["git", "show", "origin/users/sagik/shraga-worker:VERSION"],
        cwd=self.repo_path, capture_output=True, text=True
    )

    remote_version = result.stdout.strip()

    if remote_version != self.current_version:
        return True  # Update available
    return False

def apply_update(self):
    """Pull latest code and restart worker"""
    subprocess.run(["git", "pull"], cwd=self.repo_path)
    sys.exit(0)  # Task Scheduler restarts us
```

---

### 3. Git Results Committing

**Added**: `commit_task_results()` - Commit working directory after task completion

**Flow**:
1. Task completes successfully
2. Worker commits all changes to Git
3. Includes commit SHA in Dataverse result
4. Provides audit trail of Claude's work

**Code added**:
```python
def commit_task_results(self, task_id, work_dir):
    """Commit task results to Git for audit trail"""
    # Add all changes
    subprocess.run(["git", "add", "."], cwd=work_dir)

    # Commit with task ID
    commit_msg = f"Task {task_id}: Completed by autonomous agent"
    subprocess.run(["git", "commit", "-m", commit_msg], cwd=work_dir)

    # Get commit SHA
    result = subprocess.run(
        ["git", "rev-parse", "HEAD"],
        cwd=work_dir, capture_output=True, text=True
    )

    return result.stdout.strip()
```

**Integration in process_task()**:
```python
if success:
    # Commit results
    commit_sha = self.commit_task_results(task_id, self.work_base_dir)

    # Include commit SHA in result
    result_with_git = f"{result}\n\n[Git Commit: {commit_sha[:8]}]"

    # Update Dataverse with commit info
    self.update_task(task_id, result=result_with_git, ...)
```

---

### 4. Main Loop Update

**Changed**: Main loop now checks for updates when idle

**Before**:
```python
while True:
    tasks = self.poll_pending_tasks()

    if tasks:
        for task in tasks:
            self.process_task(task)

    time.sleep(10)
```

**After**:
```python
while True:
    tasks = self.poll_pending_tasks()

    if tasks:
        for task in tasks:
            self.process_task(task)
    else:
        # IDLE - Check for updates (every 10 minutes)
        now = datetime.now()
        if (now - self.last_update_check) >= timedelta(minutes=10):
            self.last_update_check = now

            if self.check_for_updates():
                self.send_to_webhook("üîÑ Updating worker...")
                self.apply_update()  # Pulls and exits

    time.sleep(10)
```

---

### 5. Imports Added

```python
from datetime import datetime, timezone, timedelta
from azure.identity import DefaultAzureCredential
from azure.core.credentials import AccessToken
```

---

### 6. __init__ Updated

```python
def __init__(self):
    # ... existing code ...

    # Azure authentication
    self.credential = DefaultAzureCredential()
    self._token_cache = None
    self._token_expires = None

    # Version tracking
    self.repo_path = Path(__file__).parent
    self.current_version = self.load_version()
    self.last_update_check = None
    self.update_check_interval = timedelta(minutes=10)
```

---

## Testing Checklist

### Before Testing:
- [ ] Install azure-identity: `pip install azure-identity`
- [ ] Run `az login` to authenticate
- [ ] Verify VERSION file exists in repo
- [ ] Ensure Git configured for worker repo

### Test 1: Authentication
```bash
python integrated_task_worker.py
```
**Expected**: Worker starts, gets token via DefaultAzureCredential

### Test 2: Version Check (Idle)
1. Let worker run idle for 10+ minutes
2. **Expected**: Worker checks for updates
3. **Output**: `[IDLE] Checking for updates...`

### Test 3: Version Update
1. Update VERSION file in repo: `1.0.0` ‚Üí `1.0.1`
2. Commit and push
3. Wait for worker to check (10 min or restart)
4. **Expected**: Worker pulls and restarts automatically

### Test 4: Git Commit
1. Submit task via Dataverse
2. Worker processes task
3. **Expected**: Working directory committed to Git
4. **Output**: `[GIT] Committed as abc12345`
5. Verify: `git log` shows new commit

### Test 5: Task Result with Git SHA
1. Check Dataverse after task completes
2. **Expected**: Result includes `[Git Commit: abc12345]`

---

## Rollback Plan

If issues occur:

```bash
cd Q:\repos\Users\sagik\shraga-worker
git log --oneline -5
git checkout <previous-commit>
```

Or revert specific file:
```bash
git checkout HEAD~1 integrated_task_worker.py
```

---

## Next Steps

1. ‚úÖ Review changes carefully
2. ‚è≥ Test locally
3. ‚è≥ Get user approval
4. ‚è≥ Commit changes
5. ‚è≥ Update VERSION to 1.0.0
6. ‚è≥ Push to repo

---

**End of Changes Document**
